<!DOCTYPE html> 
<html>
<head>
<meta charset="utf-8">
<title>Simulador AVL</title>
<meta name="viewport" content="width=device-width, initial-scale=1"> 
<link rel="stylesheet" href="css/jquery.mobile-1.3.0.css" />
<!--link rel="stylesheet" href="css/jquery.mobile.structure-1.0.min.css" />
<link rel="stylesheet" href="css/jquery.mobile.theme-1.0.min.css" />
<link rel="stylesheet" type="text/css" href="css/tolito-1.0.2.min.css" /-->

<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
<script type="text/javascript" src="js/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="js/jquery.mobile-1.3.0.min.js"></script>
<script type="text/javascript" charset="utf-8" src="js/cordova-2.5.0.js"></script>
<!--script type="text/javascript" src="js/tolito-1.0.2.min.js"></script-->

<script src="ui/min/jquery.ui.map.full.min.js" type="text/javascript"></script>
<script type="text/javascript" src="ui/min/jquery.ui.map.min.js"></script>
<script type="text/javascript" src="ui/min/jquery.ui.map.services.min.js"></script>
<script type="text/javascript">
	var latActual;
	var lngActual;

	var mobileDemo = { 'center': '-32.890615,-68.8484', 'zoom': 10 };

	var watchID = null;
    document.addEventListener("deviceready", onDeviceReady, false);


    function onDeviceReady() {
    	$.support.cors = true;
		$.mobile.allowCrossDomainPages = true;
	}

	$(document).on('pageinit', '#geoPos',  function(){
		$('#map_canvas_2').gmap({
			'center': mobileDemo.center, 
			'zoom': mobileDemo.zoom, 
			'disableDefaultUI':true, 
			'callback': function(map) {
				var self = this;
				var options = { timeout: 30000 };
        		watchID = navigator.geolocation.watchPosition(function(position) {
        			var latlng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
		        	if (!self.get('markers').client) {
						self.addMarker({ 'id': 'client', 'position': latlng, 'bounds': true });
					} else {
						self.get('markers').client.setPosition(latlng);
						map.panTo(latlng);
					}
        		}, function(error){
        			alert("x" + error);
        		}, options);
			}
		});
	});
/*
	$(document).on('pageshow', '#geoPos',  function(){
		 $('#map_canvas_2').gmap('refresh');
	});
	
	$(document).on('pagehide', '#geoPos',  function(){
		$('#map_canvas_2').gmap('clearWatch'); 
		if (watchID != null) {
            navigator.geolocation.clearWatch(watchID);
            watchID = null;
        }
	});*/
	//boton enviar posicion actual
	$("#btnEnviarPosActual").click(function (){
		$("#map_canvas_2").fadeOut("slow", function(){
			$("#map_canvas_2").fadeIn("slow", function() {				
			});
		});
		navigator.geolocation.getCurrentPosition(function(position) {
			Enviar(position.coords.latitude, position.coords.longitude);
		},function(error){
    		alert(error.message);
    	});
		
	});

	function Enviar(lat, lng) {
		//web service para insertar recorrido
		$.ajax({
            type: "POST",
            url: "http://" + $("#ip").val() + "/wstracking/WebService1.asmx/insertData",
            data: "{movilid:" + $("#idequipoSelect").val() + ",lat:'" + lat + "',lng:'" + lng + "',vel:0,rum:0,evento:0,panico:0,fueradeservicio:0,input3:0,input4:0,ocupado:0,input6:0,sms:0,contacto:0,conf:'conf'}",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
			success: function(data) {
				//$('#result').html(data.d);
			},
            error: function (msg) {
                $('#result').html(msg.statusText);
            }
        });
	}

</script>
</head>
<body> 

<div data-role="page" id="geoPos" data-position="fixed">
	<div data-role="header">
		<h1>Posici√≥n actual</h1>
	</div>
	<div data-role="content">
		<div class="ui-bar-c ui-corner-all ui-shadow" style="padding:1em;">
			<div id="map_canvas_2" style="height:300px;"></div>
		</div>
		<a  href="" data-role="button" id="btnEnviarPosActual">Enviar</a>
        <div id="result"></div>
	</div>	
	<div data-role="footer" data-position="fixed">
		<h5>Desarrollado por Daniel Alvarez..</h5>
	</div>
</div>
</body>
</html>