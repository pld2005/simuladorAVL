<!DOCTYPE html> 
<html>
<head>
<meta charset="utf-8">
<title>Simulador AVL</title>


<meta name="viewport" content="width=device-width, initial-scale=1"> 
<link rel="stylesheet" href="css/jquery.mobile-1.3.0.min.css" />
<link rel="stylesheet" type="text/css" href="css/tolito-1.0.2.min.css" />
<script type="text/javascript" src="js/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="js/jquery.mobile-1.3.0.min.js"></script>
<script type="text/javascript" charset="utf-8" src="js/cordova-2.5.0.js"></script>
<script type="text/javascript" src="js/tolito-1.0.2.min.js"></script>
<script type="text/javascript" charset="utf-8">

    // Wait for Cordova to load
    // 
	var recorridoArray = [];
	var cantRecorrido = 0;
	var recorridoIndex = 0;
	var MyTimer;
	var sec = 30
	var timer;
	var progressbar1 = TolitoProgressBar('progressbar')
            .setOuterTheme('b')
            .setInnerTheme('e')
            .isMini(true)
            .setMax(100)
            .setStartFrom(0)
            .setInterval(10)
            .showCounter(true)
            .logOptions()
            .build();


    document.addEventListener("deviceready", onDeviceReady, false);

    // Cordova is loaded and it is now safe to make calls Cordova methods
    //
    function onDeviceReady() {
		$.mobile.allowCrossDomainPages = true;

		$("#btnchecknetwork").click(function (){
			checkConnection();
		})
		
		$("#btnpos").click(function (){
			obtenerPocision();
		})
		

    }
	function Recorrido(movilid, lat,lng,vel,rum,evento,panico,fueradeservicio,input3,input4,ocupado,input6,sms,contacto,conf){
		return {
			movilid:movilid,
			lat:lat,
			lng:lng,
			vel:vel,
			rum:rum,
			evento:evento,
			panico:panico,
			fueradeservicio:fueradeservicio,
			input3:input3,
			input4:input4,
			ocupado:ocupado,
			input6:input6,
			sms:sms,
			contacto:contacto,
			conf:conf
		}
	}

	function EnviarRecorrido() {
		if (recorridoIndex<=cantRecorrido) {
			progressbar1.setValue(recorridoIndex/cantRecorrido*100);
			$.ajax({
                type: "POST",
                url: "http://" + $("#ip").val() + "/wstracking/WebService1.asmx/insertData",
                data: "{movilid:" + $("#idequipoSelect").val() + ",lat:'" + recorridoArray[recorridoIndex].lat + "',lng:'" + recorridoArray[recorridoIndex].lng + "',vel:0,rum:0,evento:0,panico:0,fueradeservicio:0,input3:0,input4:0,ocupado:0,input6:0,sms:0,contacto:0,conf:'conf'}",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
				success: function(data) {
					$('#result').html(data.d);
				},
                error: function (msg) {
                    $('#result').html(msg.statusText);
                }
            });
			recorridoIndex = recorridoIndex +1;
			$('#result').html("Simulando delay de AVL. Espere por favor...");
		}else{
			$('#result').html("Envio completado!" + recorridoIndex);
			$("progressbar").fadeOut();
			clearInterval(MyTimer);
			MyTimer =null;
		}
	}
	
	function obtenerPocision() {
		navigator.geolocation.getCurrentPosition(function (posicion){
				var text = posicion.coords.latitude + " " + posicion.coords.longitude;
				$("#msjpopup").html(text);
				$.mobile.changePage('#popupBasic', {transition: 'pop', role: 'dialog'}); 
			}, 
			function() {
				$("#msjpopup").html("Error GPS!")
				$("#popupBasic").popup('open');
			});
			
	}
    function checkConnection() {
        var networkState = navigator.connection.type;

        var states = {};
        states[Connection.UNKNOWN]  = 'Unknown connection';
        states[Connection.ETHERNET] = 'Ethernet connection';
        states[Connection.WIFI]     = 'WiFi connection';
        states[Connection.CELL_2G]  = 'Cell 2G connection';
        states[Connection.CELL_3G]  = 'Cell 3G connection';
        states[Connection.CELL_4G]  = 'Cell 4G connection';
        states[Connection.NONE]     = 'No network connection';

		var text = "Tipo de conexion: " + states[networkState];
		$("#msjpopup").html(text);
		$.mobile.changePage('#popupBasic', {transition: 'fade', role: 'dialog'}); 
        
    }

//se ejecuta cuando se inicia la pagina indicada
	$(document).on('pageinit', '#resultXML',  function(){
		//leer moviles de la demo
		$.ajax({
			type: "POST",
			url: "http://" + $("#ip").val() + "/wstracking/WebService1.asmx/GetMoviles",
			data: "{ idpropietario: 33}",
			contentType: "application/json; charset=utf-8",
			datatype: "json",
			success: function (data) {
				var optionlist="";
				var movil = data.d;
	            $.each(movil, function (index, m) {
					optionlist += '<option value=' + m.IdEquipo + '>' + m.Patente + '</option>'; 
	            });
	            $("#idequipoSelect").html(optionlist).selectmenu('refresh', true); 
	            $('#result').html(optionlist);   
			},
			error: function (err) {
				alert('Error');
			}
		});


		//leer xml con recorrido
		$.ajax({
			type: "GET",
			url: "reportes.xml",
			dataType: "xml",
			success: parseXml
			});
		
        
		//set timer para enviar recorrido cada 30 segundos
		$("#btnSend").click(function (){
			recorridoIndex=0;
			$('#result').html("Simulando delay de AVL. Espere por favor...");
			
			$('#btnSend').fadeOut('fast');

			MyTimer = setInterval(function () { 
				EnviarRecorrido();
				//timer para segundero
				$('#countDown').fadeIn();
				timer = setInterval(function() { 
   					$('#countDown span').text(sec--);
   					if (sec == -1) {
      					$('#countDown').fadeOut('fast');
      					clearInterval(timer);
   					} 
				}, 1000);
			}, 30000);
		})

		$("#btnCancelar").click(function (){
			$('#result').html("Envio canceladp!");
			$("progressbar").fadeOut();
			$('#btnSend').fadeIn('fast');
			$('#countDown').fadeOut('fast');
			clearInterval(MyTimer);
			clearInterval(timer);
			timer=null;
			sec=30;
			MyTimer =null;
		});
	});
	
	function parseXml(xml) {
		
		$(xml).find('reporte').each(function() {
			var r = Recorrido(6033, 
							  $(this).find("lat").text(), 
							  $(this).find("lng").text(), 
							  0, 
							  0,
							  $(this).find("estado").text(),
							  0, 0, 0, 0, 0, 0, 0, 0,"");
			
			recorridoArray.push(r);
			
	
			cantRecorrido = cantRecorrido + 1;
			//$("#resultXMLlist").append('<li>Lat:' + $(this).find("lat").text() + ' / Lng:' + $(this).find("lng").text() + '</li>').listview('refresh');
			
		});
		
	}
	
	
    </script>
</head> 
<body> 

<div data-role="page" id="page">
	<div data-role="header">
		<h1>Simulador AVL</h1>
	</div>
	<div data-role="content">	
    	<label for="ip">IP:</label>
    	<input type="text" name="ip" id="ip" value="190.220.216.249"  />

    	<a href="" data-role="button" id="btnpos">pos</a>
        <a href="" data-role="button" id="btnchecknetwork">Chequear Red</a>
        <a href="#resultXML" data-role="button" id="btnreadXML">Leer XML</a>


		<ul data-role="listview">
			<li><a href="#page2">Simular Recorrido</a></li>
            <li><a href="#page3">Enviar Panico</a></li>
		</ul>		
	</div>
	<div data-role="footer">
		<h4>Desarrollado por Daniel Alvarez</h4>
	</div>
</div>

<div data-role="page" id="page2">
	<div data-role="header">
		<h1>Simular Recorrido</h1>
	</div>
	<div data-role="footer">
		<h5>Desarrollado por Daniel Alvarez</h5>
	</div>
</div>

<div data-role="page" id="page3">
	<div data-role="header">
		<h1>Enviar Panico</h1>
	</div>
	<div data-role="content">	
		Contenido		
	</div>
	<div data-role="footer">
		<h4>Desarrollado por Daniel Alvarez</h4>
	</div>
</div>

<div data-role="page" id="resultXML">
	<div data-role="header">
		<h1>Contenido XML</h1>
	</div>
	<div data-role="content">	
    
		<label for="idequipoSelect">Seleccione un movil: </label>
		<select id="idequipoSelect" name="idequipoSelect"></select>
        <a  href="" data-role="button" id="btnSend">Enviar datos de recorrido.</a>
		<div id="countDown"  style="display: none;">
			Se enviará una nueva posición dentro de <span>30</span> seg.
			<a  href="" data-role="button" id="btnCancelar">Cancelar</a>
		</div>
        <div id="progressbar"></div>
        <div id="result"></div>
	</div>

</div>

<div id="popupBasic" data-role="popup" data-overlay-theme="b" data-theme="a" class="ui-content">
    <a href="#" data-rel="back" data-role="button" data-theme="e" data-icon="delete" data-iconpos="notext" class="ui-btn-left">Close</a>
	<div id="msjpopup"  data-theme="e" ></div>
</div>

</body>

</html>